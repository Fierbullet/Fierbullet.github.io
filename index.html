<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>M√©lange ‚Äî –ú–µ–ª–∞–Ω–∂ ‚Äî –¶–≤–µ—Ç–æ—á–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<style>
:root{--accent-dark:#5d6f4f;--accent:#8aa776;--muted:#eef2ea;--bg:#f6f7f4;--card:#fff;--text:#222;--soft-shadow:0 6px 18px rgba(93,111,79,0.06)}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:"Inter",Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.4}
nav{position:sticky;top:0;z-index:60;background:linear-gradient(135deg,var(--accent-dark),var(--accent));padding:12px 18px;box-shadow:0 2px 10px rgba(0,0,0,0.06)}
.nav-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
.logo{color:#fff;font-weight:700;letter-spacing:0.4px;display:flex;align-items:center;gap:10px;font-size:1.05rem}
.logo span{font-size:1.5rem}
.nav-links{display:flex;gap:14px;align-items:center}
.nav-links a{color:#fff;text-decoration:none;font-weight:600;padding:6px 10px;border-radius:8px;opacity:0.95}
.cart-icon{position:relative;cursor:pointer;font-size:1.25rem;color:#fff}
.cart-count{position:absolute;top:-8px;right:-10px;background:#2f4d30;color:#fff;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.78rem}
.hero{background:url('Airbrush-Image-Enhancer-1760695648307.jpg') center/cover no-repeat;min-height:340px;display:flex;align-items:center;justify-content:center;padding:48px 16px;box-shadow:0 6px 24px rgba(0,0,0,0.05)}
.hero-inner{width:100%;max-width:1100px;padding:28px;text-align:left}
.hero-title{font-family:'Dancing Script',cursive;color:#fff;font-size:2.6rem;line-height:1;margin-bottom:8px;text-shadow:0 6px 20px rgba(0,0,0,0.45)}
.hero-sub{color:#fff;font-size:1.05rem;margin-bottom:10px;text-shadow:0 6px 18px rgba(0,0,0,0.35)}
.hero-meta{color:#fff;opacity:0.95;font-weight:600;text-shadow:0 4px 12px rgba(0,0,0,0.32)}
.category-tiles{max-width:1100px;margin:18px auto 0;padding:0 16px;display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.cat-tile{background:var(--card);border-radius:12px;height:92px;display:flex;align-items:center;padding:12px 16px;gap:12px;cursor:pointer;box-shadow:var(--soft-shadow);border:1px solid rgba(47,77,48,0.03);transition:transform .12s,box-shadow .12s,border-color .12s}
.cat-tile:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(45,73,44,0.06)}
.cat-tile h3{font-size:1.05rem;color:var(--accent-dark);margin:0;font-weight:700}
.cat-tile p{font-size:0.92rem;color:#6b6b6b;margin:0 0 0 auto;text-align:right}
main{max-width:1100px;margin:18px auto 80px;padding:0 16px}
.catalog-section{margin-top:18px}
.catalog-title{font-size:1.28rem;margin-bottom:12px;color:var(--accent-dark)}
.products-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
.product-card{background:var(--card);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--soft-shadow);border:1px solid rgba(47,77,48,0.03)}
.product-image{height:180px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:2.4rem;color:var(--accent-dark);background:linear-gradient(180deg,rgba(240,246,236,0.6),rgba(250,252,248,0.4))}
.product-info h3{font-size:1.05rem;margin:0;color:var(--text)}
.product-price{font-weight:700;color:var(--accent-dark)}
.product-controls{display:flex;gap:8px;align-items:center;margin-top:auto}
.btn{background:var(--accent-dark);color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;color:var(--accent-dark);border:1px solid rgba(93,111,79,0.08)}
.modal{display:none;position:fixed;z-index:1200;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);overflow:auto;padding:40px 18px}
.modal-content{background:#fff;margin:40px auto;border-radius:12px;max-width:760px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.25)}
.modal-header{display:flex;justify-content:center;align-items:center;margin-bottom:10px}
.modal-header h3{font-family:Helvetica,'Arial',sans-serif;margin:0;font-weight:600;font-size:1.05rem}
.close{position:absolute;right:18px;top:12px;background:none;border:none;font-size:26px;cursor:pointer;color:#666;}
.cart-items{max-height:360px;overflow:auto;margin-bottom:12px}
.cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:var(--muted);margin-bottom:10px;border-left:4px solid var(--accent-dark)}
.cart-item .cart-item-name{font-weight:700;color:var(--accent-dark)}
.cart-total{background:linear-gradient(90deg,var(--accent-dark),var(--accent));color:white;padding:12px;border-radius:8px;font-weight:700;text-align:right}
.form-group{margin-bottom:10px}
.form-input{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;font-size:1rem;font-family:Helvetica,'Arial',sans-serif}
.form-textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #eee;font-size:1rem;font-family:Helvetica,'Arial',sans-serif;min-height:80px;resize:vertical}
.success-modal{display:none;position:fixed;z-index:1300;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;padding:24px}
.success-card{background:#fff;border-radius:14px;padding:18px;max-width:640px;width:100%;box-shadow:0 18px 60px rgba(0,0,0,0.16);position:relative;}
.success-close{position:absolute;right:12px;top:8px;background:none;border:none;font-size:20px;cursor:pointer;color:#666;}
.success-text{font-size:1rem;color:#222;line-height:1.5}
.history-list{max-height:320px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px;}
.history-item{background:#fff;border-radius:8px;padding:8px;border:1px solid rgba(0,0,0,0.04);box-shadow:var(--soft-shadow);}
footer{background:var(--accent-dark);color:white;padding:26px;text-align:center;border-top-left-radius:16px;border-top-right-radius:16px;margin-top:36px}
@media (max-width:980px){ .category-tiles{grid-template-columns:repeat(3,1fr);gap:10px} .cat-tile{height:86px} }
@media (max-width:700px){ .hero-title{font-size:2.1rem} .category-tiles{grid-template-columns:1fr} .cat-tile{height:86px} .product-image{height:140px} .modal-content{margin:20px 8px} .success-card{margin:0 12px} }
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <div class="nav-links">
      <a href="#catalog" onclick="showCategory('bouquets')">–ö–∞—Ç–∞–ª–æ–≥</a>
      <a href="#contacts">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
      <a href="#" onclick="openHistoryModal();return false;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</a>
      <div class="cart-icon" onclick="openCart()">
        üõí <div class="cart-count" id="cartCount">0</div>
      </div>
    </div>
  </div>
</nav>

<section class="hero" role="banner">
  <div class="hero-inner">
    <div class="hero-title">M√©lange</div>
    <div class="hero-sub">–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–µ —Ü–≤–µ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ –∂–∏–∑–Ω–∏ ‚Äî —Å–æ–±–µ—Ä–∏ —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –≤ –±—É–∫–µ—Ç  ~</div>
  </div>
</section>

<div class="category-tiles" aria-hidden="false">
  <div class="cat-tile" id="tile-bouquets" onclick="onCatClick('bouquets')">
    <div>
      <h3>–ù–µ –ø—Ä–æ—Å—Ç–æ –±—É–∫–µ—Ç—ã</h3>
      <div style="color:#687a5f;font-size:0.92rem;margin-top:6px">–ì–æ—Ç–æ–≤—ã–µ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è</div>
    </div>
    <p>–°–º–æ—Ç—Ä–µ—Ç—å ‚Üí</p>
  </div>

  <div class="cat-tile" id="tile-decor" onclick="onCatClick('decor')">
    <div>
      <h3>–í–µ—Ç–æ—á–∫–∏ –∏ –¥–µ–∫–æ—Ä</h3>
      <div style="color:#687a5f;font-size:0.92rem;margin-top:6px">–≠–≤–∫–∞–ª–∏–ø—Ç, —è–≥–æ–¥—ã, –∑–µ–ª–µ–Ω—å</div>
    </div>
    <p>–°–º–æ—Ç—Ä–µ—Ç—å ‚Üí</p>
  </div>

  <div class="cat-tile" id="tile-flowers" onclick="onCatClick('flowers')">
    <div>
      <h3>–ù–µ –ø—Ä–æ—Å—Ç–æ —Ü–≤–µ—Ç—ã</h3>
      <div style="color:#687a5f;font-size:0.92rem;margin-top:6px">–°—Ç–µ–±–ª–∏ –ø–æ—à—Ç—É—á–Ω–æ –¥–ª—è —Å–±–æ—Ä–∫–∏</div>
    </div>
    <p>–°–º–æ—Ç—Ä–µ—Ç—å ‚Üí</p>
  </div>
</div>

<main id="catalog">
  <section class="catalog-section" id="section-bouquets" data-section="bouquets">
    <div class="catalog-title">–ë—É–∫–µ—Ç—ã</div>
    <div class="products-grid" id="bouquetsGrid"></div>
  </section>

  <section class="catalog-section" id="section-decor" data-section="decor" style="display:none">
    <div class="catalog-title">–í–µ—Ç–æ—á–∫–∏ ¬∑ –î–µ–∫–æ—Ä</div>
    <div class="products-grid" id="decorGrid"></div>
  </section>

  <section class="catalog-section" id="section-flowers" data-section="flowers" style="display:none">
    <div class="catalog-title">–ù–µ –ø—Ä–æ—Å—Ç–æ —Ü–≤–µ—Ç—ã</div>
    <div class="products-grid" id="flowersGrid"></div>
  </section>

  <section class="catalog-section" id="contacts" style="margin-top:34px">
    <div class="catalog-title">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="background:var(--card);padding:12px;border-radius:10px;min-width:200px;box-shadow:var(--soft-shadow)">
        <strong>–ê–¥—Ä–µ—Å</strong><div>–±—É–ª. –î–º–∏—Ç—Ä–∏—è –î–æ–Ω—Å–∫–æ–≥–æ, 6</div>
      </div>
      <div style="background:var(--card);padding:12px;border-radius:10px;min-width:200px;box-shadow:var(--soft-shadow)">
        <strong>–¢–µ–ª–µ—Ñ–æ–Ω</strong><div><a href="tel:+79994668624">+7 (999) 466-86-24</a></div>
      </div>
      <div style="background:var(--card);padding:12px;border-radius:10px;min-width:200px;box-shadow:var(--soft-shadow)">
        <strong>–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</strong><div>–ü–Ω-–ü—Ç: 10:00 - 20:00<br>–°–±-–í—Å: 10:00 - 18:00</div>
      </div>
    </div>
  </section>
</main>

<!-- CART MODAL -->
<div id="cartModal" class="modal" onclick="modalOutsideClick(event,'cartModal')">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>üõí –ö–æ—Ä–∑–∏–Ω–∞</h3>
      <button class="close" onclick="closeCart()">&times;</button>
    </div>
    <div id="cartContent"></div>
  </div>
</div>

<!-- ORDER MODAL -->
<div id="orderModal" class="modal" onclick="modalOutsideClick(event,'orderModal')">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div class="modal-header">
      <h3>üìã –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</h3>
      <button class="close" onclick="closeOrder()">&times;</button>
    </div>

    <div id="orderError" style="margin-bottom:8px"></div>

    <form id="orderForm">
      <div class="form-group">
        <input id="name" class="form-input" placeholder="–í–∞—à–µ –∏–º—è" required />
      </div>
      <div class="form-group">
        <input id="phone" class="form-input" type="tel" placeholder="+7 (999) 456 78 90" required />
      </div>
      <div class="form-group">
        <input id="email" class="form-input" type="email" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à e-mail (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      </div>
      <div class="form-group">
        <input id="address" class="form-input" placeholder="—É–ª. –¥–æ–º. —ç—Ç. –∫–≤." required />
      </div>
      <div class="form-group">
        <input id="date" class="form-input" type="date" placeholder="–¥–¥.–º–º.–≥–≥–≥–≥" required />
      </div>
      <div class="form-group">
        <textarea id="message" class="form-textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
      </div>

      <div style="margin-top:6px">
        <button id="submitBtn" type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </form>
  </div>
</div>

<!-- SUCCESS POPUP -->
<div id="successModal" class="success-modal" aria-hidden="true">
  <div class="success-card" role="dialog" aria-modal="true" aria-labelledby="successTitle">
    <button class="success-close" onclick="closeSuccess()">‚úï</button>
    <div class="success-text" id="successContent"></div>
  </div>
</div>

<!-- ORDER HISTORY MODAL -->
<div id="historyModal" class="modal" onclick="modalOutsideClick(event,'historyModal')">
  <div class="modal-content">
    <div class="modal-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3><button class="close" onclick="closeHistory()">‚úï</button></div>
    <div class="history-list" id="historyList"></div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn ghost" onclick="clearHistory()">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      <button class="btn" onclick="closeHistory()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<footer>&copy; 2025 –ú–µ–ª–∞–Ω–∂ ‚Äî —Ü–≤–µ—Ç–æ—á–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω.</footer>

<script>
/* ========== –î–ê–ù–ù–´–ï ========== */
const BOUQUETS=[{id:1,name:'–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –±—É–∫–µ—Ç',price:2500,emoji:'üåπ'},{id:2,name:'–°–æ–ª–Ω–µ—á–Ω—ã–π –º–∏–∫—Å',price:2000,emoji:'üåº'},{id:3,name:'–í–µ—Å–µ–Ω–Ω–∏–π –ø—Ä–∞–∑–¥–Ω–∏–∫',price:1800,emoji:'üå∑'},{id:4,name:'–ö–æ–º–ø–æ–∑–∏—Ü–∏—è –¥–µ –ª—é–∫—Å',price:3500,emoji:'üíê'},{id:5,name:'–ù–µ–∂–Ω–æ—Å—Ç—å',price:2200,emoji:'üå∏'}];
const FLOWERS=[{id:100,name:'–•—Ä–∏–∑–∞–Ω—Ç–µ–º–∞ 60 —Å–º',price:259,emoji:'üåº'},{id:101,name:'–ì–µ—Ä–±–µ—Ä–∞ –º–∏–∫—Å',price:200,emoji:'üå∏'},{id:102,name:'–ì–∏–ø–µ—Ä–∏–∫—É–º –º–∏–∫—Å',price:300,emoji:'üçí'},{id:103,name:'–ú–∞–≥–Ω—É–º',price:350,emoji:'üå∫'},{id:104,name:'–ù–µ—Ä–∏–Ω–µ –í–µ—Å—Ç–∞ (—Å–≤–µ—Ç–ª–æ-—Ä–æ–∑)',price:280,emoji:'üå∑'},{id:105,name:'–ü–æ–¥—Å–æ–ª–Ω—É—Ö',price:350,emoji:'üåª'},{id:106,name:'–≠—É—Å—Ç–æ–º–∞',price:400,emoji:'üíÆ'},{id:107,name:'–¶–∏–º–±–∏–¥–∏—É–º –º–∏–∫—Å (1 —à—Ç.)',price:350,emoji:'üåø'},{id:108,name:'–†–æ–∑–∞ –ú–æ–Ω–¥–∏–∞–ª—å 60 —Å–º',price:300,emoji:'üåπ'},{id:109,name:'–†–æ–∑–∞ –ü–∏–Ω–∫ –§–ª–æ–π–¥ 60 —Å–º',price:350,emoji:'üå∑'},{id:110,name:'–†–æ–∑–∞ –†–µ–¥ –ù–∞–æ–º–∏ 60 —Å–º',price:250,emoji:'üåπ'},{id:111,name:'–†–æ–∑–∞ –∫—É—Å—Ç–æ–≤–∞—è –ú–∏—Å—Ç–∏ –ë–∞–±–ª–∑',price:550,emoji:'üíê'},{id:112,name:'–†–æ–∑–∞ –≠–∫–≤–∞–¥–æ—Ä –º–∏–∫—Å 60',price:280,emoji:'üåπ'}];
const DECOR=[{id:200,name:'–≠–≤–∫–∞–ª–∏–ø—Ç',price:300,emoji:'üåø'},{id:201,name:'–í–µ—Ç–∫–∞ —è–≥–æ–¥',price:300,emoji:'üçì'},{id:202,name:'–ì–∏–ø—Å–æ—Ñ–∏–ª–∞ –∫—Ä–∞—à. –†–µ–π–Ω–±–æ—É',price:300,emoji:'üåà'},{id:203,name:'–ë—Ä—É–Ω–∏—è',price:300,emoji:'üåæ'},{id:204,name:'–õ–∞–≤–∞–Ω–¥–∞',price:300,emoji:'üíú'},{id:205,name:'–°–æ–ª–∏–¥–∞–≥–æ',price:250,emoji:'üåº'},{id:206,name:'–¢—Ä–∞—Ö–µ–ª–∏—É–º –ë–ª—é –õ—ç–π–∫ –ú–∏—á–∏–≥–∞–Ω',price:250,emoji:'üíô'},{id:207,name:'–≠—Ä–∏–Ω–≥–∏—É–º –°—É–ø–µ—Ä –ù–æ–≤–∞ –ö—å—é—Å—Ç–∞—Ä',price:400,emoji:'üåå'}];

/* ========== STATE & CONFIG ========== */
let cart=[]; const cartCountEl=document.getElementById('cartCount');
const LS_CART_KEY='melange_cart_v1', LS_HISTORY_KEY='melange_orders_v1', LS_NEXT_ORDER_KEY='melange_next_order_v1';
let nextOrderNumber = (()=>{ const raw=localStorage.getItem(LS_NEXT_ORDER_KEY); if(raw) return Number(raw); localStorage.setItem(LS_NEXT_ORDER_KEY,String(344643)); return 344643 })();

// endpoints
const TELEGRAM_TOKEN='8498848056:AAE8c_yh6rCk2paOR-2ut7vRAadH4-Lrdhs';
const TELEGRAM_CHAT_ID='503216481';
const TELEGRAM_URL=`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
// –í–ê–ñ–ù–û: –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–∞–±–æ—á–∏–π URL web app –∏–∑ Apps Script (—Ç–æ—Ç –∂–µ, —á—Ç–æ –≤—ã –ø—É–±–ª–∏–∫–æ–≤–∞–ª–∏)
const GOOGLE_SHEETS_URL='https://script.google.com/macros/s/AKfycbwHXZn4FUvU8ds5vCUhOPjB-4oq7zVUWksTHkGcHZkZ1lMWRrf1Vb0fZbeA0f7kYj_lwA/exec';

/* ========== HELPERS ========== */
function findProductById(id){ return BOUQUETS.concat(FLOWERS,DECOR).find(p=>p.id===id) }
function escapeHtml(text){ return String(text).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
function escapeMd(s=''){ return String(s).replaceAll('*','\\*').replaceAll('_','\\_').replaceAll('`','\\`') }

/* ========== LOCAL STORAGE ========== */
function saveCartToStorage(){ localStorage.setItem(LS_CART_KEY,JSON.stringify(cart)) }
function loadCartFromStorage(){ try{ const raw=localStorage.getItem(LS_CART_KEY); cart = raw?JSON.parse(raw):[] }catch(e){ cart=[] } updateCartCount() }
function saveNextOrder(){ localStorage.setItem(LS_NEXT_ORDER_KEY,String(nextOrderNumber)) }
function addOrderToHistory(order){ const arr=JSON.parse(localStorage.getItem(LS_HISTORY_KEY)||'[]'); arr.unshift(order); localStorage.setItem(LS_HISTORY_KEY,JSON.stringify(arr)) }
function getHistory(){ try{ return JSON.parse(localStorage.getItem(LS_HISTORY_KEY)||'[]') }catch(e){ return [] } }

/* ========== RENDER ========== */
function renderGrid(gridId,items){ const grid=document.getElementById(gridId); grid.innerHTML = items.map(p=>`
  <div class="product-card">
    <div class="product-image">${p.emoji}</div>
    <div class="product-info">
      <h3>${escapeHtml(p.name)}</h3>
      <div class="product-price">${p.price} ‚ÇΩ</div>
      <div class="product-controls"><button class="btn" onclick="addToCart(${p.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button></div>
    </div>
  </div>
`).join('') }
function renderAll(){ renderGrid('bouquetsGrid',BOUQUETS); renderGrid('flowersGrid',FLOWERS); renderGrid('decorGrid',DECOR); updateCartCount() }

/* ========== CART ========== */
function addToCart(productId){ const prod=findProductById(productId); if(!prod) return alert('–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'); const exist=cart.find(i=>i.id===productId); if(exist) exist.qty++; else cart.push({id:prod.id,name:prod.name,price:prod.price,qty:1}); updateCartCount(); saveCartToStorage(); flashToast(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${prod.name}`) }
function updateCartCount(){ const count=cart.reduce((s,i)=>s+i.qty,0); cartCountEl.textContent=count; saveCartToStorage() }
function openCart(){ const modal=document.getElementById('cartModal'); const content=document.getElementById('cartContent'); if(cart.length===0){ content.innerHTML='<div style="padding:18px;text-align:center;color:#666">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üõí</div>' } else { const total=cart.reduce((s,i)=>s+i.price*i.qty,0); const itemsHtml=cart.map((item,idx)=>`
  <div class="cart-item">
    <div><div class="cart-item-name">${escapeHtml(item.name)}</div><div class="cart-item-price">${item.price} ‚ÇΩ √ó ${item.qty} = ${item.price*item.qty} ‚ÇΩ</div></div>
    <div style="display:flex;gap:6px;align-items:center">
      <button class="btn ghost" onclick="updateQty(${idx},-1)">-</button>
      <div style="min-width:26px;text-align:center">${item.qty}</div>
      <button class="btn ghost" onclick="updateQty(${idx},1)">+</button>
      <button class="btn" style="background:#c94a4a" onclick="removeFromCart(${idx})">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
`).join(''); content.innerHTML = `<div class="cart-items">${itemsHtml}</div><div style="margin-top:10px"><div class="cart-total">–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</div><div style="margin-top:10px;display:flex;gap:10px"><button class="btn" onclick="openOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button><button class="btn ghost" onclick="clearCart()">–û—á–∏—Å—Ç–∏—Ç—å</button></div></div>` } modal.style.display='block' }
function closeCart(){ document.getElementById('cartModal').style.display='none' }
function updateQty(idx,change){ cart[idx].qty += change; if(cart[idx].qty<=0) cart.splice(idx,1); updateCartCount(); saveCartToStorage(); openCart() }
function removeFromCart(idx){ cart.splice(idx,1); updateCartCount(); saveCartToStorage(); openCart() }
function clearCart(){ cart=[]; updateCartCount(); saveCartToStorage(); openCart(); flashToast('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞') }

/* ========== ORDER FLOW ========== */
let orderSubmitting = false; // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

function openOrder(){ if(cart.length===0) return alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞! –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã.'); closeCart(); const modal=document.getElementById('orderModal'); const dateInput=document.getElementById('date'); const today=new Date().toISOString().split('T')[0]; dateInput.setAttribute('min',today); document.getElementById('orderError').innerHTML=''; modal.style.display='block' }
function closeOrder(){ document.getElementById('orderModal').style.display='none' }

async function sendToTelegram(text){
  try{
    const res = await fetch(TELEGRAM_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text, parse_mode: 'Markdown' })
    });
    return res.ok;
  } catch(e){ console.error('Telegram send error',e); return false; }
}

// —Ç–æ–ª—å–∫–æ form->iframe (–±–µ–∑ fetch fallback) ‚Äî —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–π –∑–∞–ø–∏—Å–∏
function submitToSheetsViaForm(data){
  try {
    let iframe = document.getElementById('hidden_iframe');
    if(!iframe){
      iframe = document.createElement('iframe');
      iframe.style.display='none';
      iframe.name='hidden_iframe';
      iframe.id='hidden_iframe';
      iframe.src = 'about:blank';
      document.body.appendChild(iframe);
    } else {
      iframe.src = 'about:blank';
    }

    const form = document.createElement('form');
    form.style.display='none';
    form.method='POST';
    form.action = GOOGLE_SHEETS_URL;
    form.target = 'hidden_iframe';
    form.acceptCharset = 'UTF-8';
    form.enctype = 'application/x-www-form-urlencoded';

    const orderFields = ['name','phone','email','address','date','items','total','message','orderTimestamp','orderNumber'];
    orderFields.forEach(k=>{
      const input = document.createElement('input');
      input.type='hidden';
      input.name = k;
      input.value = data[k] === undefined ? '' : String(data[k]);
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    setTimeout(()=>{ try{ form.remove(); }catch(e){} }, 5000);

    return true;
  } catch (err){
    console.error('submitToSheetsViaForm error', err);
    return false;
  }
}

async function submitOrder(e){
  e.preventDefault();
  if (orderSubmitting) return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
  orderSubmitting = true;

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true; submitBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é...';
  document.getElementById('orderError').innerHTML = '';

  const name=document.getElementById('name').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const email=document.getElementById('email').value.trim();
  const address=document.getElementById('address').value.trim();
  const date=document.getElementById('date').value;
  const message=document.getElementById('message').value.trim();

  const orderNumber = String(nextOrderNumber).padStart(6,'0');
  nextOrderNumber++; saveNextOrder();

  const itemsText = cart.map(i=>`‚Ä¢ ${i.name} x${i.qty} = ${i.price * i.qty}‚ÇΩ`).join('\n');
  const total = cart.reduce((s,i)=>s + i.price * i.qty, 0);

  const timestamp = new Date();
  const orderTimestampForSheet = (new Date(timestamp)).toLocaleString();

  const orderData = {
    orderNumber,
    name, phone, email, address, date,
    items: itemsText,
    total: String(total),
    message,
    orderTimestamp: orderTimestampForSheet
  };

  const telegramText = `üå∏ *–ù–û–í–´–ô –ó–ê–ö–ê–ó –ú–ï–õ–ê–ù–ñ* üå∏\n\n` +
    `üî¢ *‚Ññ –∑–∞–∫–∞–∑–∞:* ${orderNumber}\n` +
    `üë§ *–ò–º—è:* ${escapeMd(name)}\n` +
    `üì± *–¢–µ–ª–µ—Ñ–æ–Ω:* ${escapeMd(phone)}\n` +
    `üìß *Email:* ${escapeMd(email || '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n` +
    `üìç *–ê–¥—Ä–µ—Å:* ${escapeMd(address)}\n` +
    `üìÖ *–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏:* ${escapeMd(date)}\n\n` +
    `üì¶ *–¢–û–í–ê–†–´:*\n${itemsText}\n\n` +
    `üí∞ *–ò–¢–û–ì–û: ${total} ‚ÇΩ*\n\n` +
    `üí¨ *–ü–æ–∂–µ–ª–∞–Ω–∏—è:* ${escapeMd(message || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã')}`;

  try{
    // 1) –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram (–µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî –ø—Ä–æ–¥–æ–ª–∂–∏–º)
    try { await sendToTelegram(telegramText); } catch(e){ console.warn('telegram fail', e); }

    // 2) –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Google Sheets (form->iframe) ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –∑–¥–µ—Å—å
    const sent = submitToSheetsViaForm(orderData);

    // 3) –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏—Å—Ç–æ—Ä–∏—é
    const clientOrder = { orderNumber, createdAt: new Date().toISOString(), name, phone, email, address, date, items: itemsText, total, sheetsOk: Boolean(sent) };
    addOrderToHistory(clientOrder);

    // 4) –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—à–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    showSuccessPopup(orderNumber, total, sent ? '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '–ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');

    // —Å–±—Ä–æ—Å UI
    document.getElementById('orderForm').reset();
    cart=[]; updateCartCount(); saveCartToStorage();
    closeOrder();

  }catch(err){
    console.error('submitOrder error',err);
    document.getElementById('orderError').innerHTML = `<div style="background:#ffeded;color:#900;padding:10px;border-radius:6px">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ: +7 (999) 466-86-24</div>`;
  } finally {
    // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–π –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–ª—É—á–∞–π–Ω–æ
    setTimeout(()=>{ orderSubmitting = false; submitBtn.disabled=false; submitBtn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑'; }, 2200);
  }
}

/* ========== HISTORY modal ========== */
function openHistoryModal(){ const modal=document.getElementById('historyModal'); const list=document.getElementById('historyList'); const arr=getHistory(); if(arr.length===0){ list.innerHTML='<div style="color:#666;padding:12px">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</div>' } else { list.innerHTML = arr.map(o=>`<div class="history-item"><div style="font-weight:700">‚Ññ ${o.orderNumber} ‚Äî ${new Date(o.createdAt).toLocaleString()}</div><div style="font-size:0.95rem;color:#444;margin-top:6px">${o.items.split('\n').map(x=>x.replace('‚Ä¢','‚úì')).join('<br>')}</div><div style="margin-top:8px;font-weight:600">–°—É–º–º–∞: ${o.total} ‚ÇΩ ‚Äî ${o.sheetsOk ? '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'}</div></div>`).join('') } modal.style.display='block' }
function closeHistory(){ document.getElementById('historyModal').style.display='none' }
function clearHistory(){ localStorage.removeItem(LS_HISTORY_KEY); openHistoryModal(); flashToast('–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞') }

/* ========== UI helpers ========== */
function showSuccessPopup(orderNumber,total,sheetsStatus){ const modal=document.getElementById('successModal'); const content=document.getElementById('successContent'); content.innerHTML = `<div style="font-weight:700;margin-bottom:8px">–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –∑–∞–∫–∞–∑!</div><div style="margin-bottom:10px">–ú—ã —É–∂–µ —Å–æ–±–∏—Ä–∞–µ–º –¥–ª—è –≤–∞—Å —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –∏ –∫—Ä–∞—Å–∏–≤—ã–π –±—É–∫–µ—Ç. –û–∂–∏–¥–∞–π—Ç–µ –∑–≤–æ–Ω–∫–∞ –æ—Ç –Ω–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π.</div><div style="background:#fbfff8;padding:10px;border-radius:8px;border:1px solid rgba(93,111,79,0.04);margin-bottom:10px"><strong>‚Ññ –∑–∞–∫–∞–∑–∞:</strong> ${orderNumber}<br><strong>–°—É–º–º–∞:</strong> ${total} ‚ÇΩ</div><div style="font-size:0.95rem;color:#444">–°—Ç–∞—Ç—É—Å –∑–∞–ø–∏—Å–∏ –≤ Google Sheets: <strong>${sheetsStatus}</strong>.</div>`; modal.style.display='flex'; modal.setAttribute('aria-hidden','false') }
function closeSuccess(){ const modal=document.getElementById('successModal'); modal.style.display='none'; modal.setAttribute('aria-hidden','true') }

function onCatClick(cat){ document.querySelectorAll('.cat-tile').forEach(t=>t.style.borderColor='rgba(47,77,48,0.03)'); if(cat==='bouquets') document.getElementById('tile-bouquets').style.borderColor='rgba(93,111,79,0.18)'; if(cat==='decor') document.getElementById('tile-decor').style.borderColor='rgba(93,111,79,0.18)'; if(cat==='flowers') document.getElementById('tile-flowers').style.borderColor='rgba(93,111,79,0.18)'; document.querySelectorAll('[data-section]').forEach(sec=>{ sec.style.display = sec.dataset.section===cat ? '' : 'none'; }); if(window.innerWidth<=700){ setTimeout(()=>scrollToCatalog(),80) } }
function showCategory(cat){ onCatClick(cat) }
function scrollToCatalog(){ const el=document.getElementById('catalog'); if(!el) return; window.scrollTo({top:el.offsetTop-16,behavior:'smooth'}) }
function modalOutsideClick(e,id){ const m=document.getElementById(id); if(e.target===m) m.style.display='none' }
function flashToast(text){ const t=document.createElement('div'); t.textContent=text; Object.assign(t.style,{position:'fixed',right:'16px',bottom:'16px',background:'#2f4d30',color:'#fff',padding:'10px 14px',borderRadius:'10px',zIndex:2000,opacity:0,transition:'opacity .18s'}); document.body.appendChild(t); requestAnimationFrame(()=>t.style.opacity=1); setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),260) },1400) }

/* ========== INIT ========== */
document.addEventListener('DOMContentLoaded',function(){
  loadCartFromStorage();
  const savedNext = localStorage.getItem(LS_NEXT_ORDER_KEY); if(savedNext) nextOrderNumber = Number(savedNext);
  renderAll(); onCatClick('bouquets');
  const d=new Date().toISOString().split('T')[0]; const dateInput=document.getElementById('date'); if(dateInput) dateInput.setAttribute('min',d);
  document.getElementById('orderForm').addEventListener('submit', submitOrder);
});
</script>
</body>
</html>
